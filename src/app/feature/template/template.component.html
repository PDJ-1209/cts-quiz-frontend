<section class="page">
  <!-- Templates View -->
  <div class="view-container" *ngIf="!showQuestionsPanel">
    <header class="page-header">
      <h1>Template Library</h1>
      <p class="sub">Pre-configured setups for quick sessions.</p>

      <div class="actions">
        <button class="btn-primary" (click)="openModal('category')">+ Category Template</button>
      </div>
    </header>

    <div *ngIf="isLoading" class="loading-message">
      <div class="spinner"></div>
      Loading templates...
    </div>

    <div class="grid" *ngIf="!isLoading">
      <div class="card template-card" *ngFor="let t of templates" (click)="viewQuestions(t)" tabindex="0" role="button">
        <div class="card-header">
          <div class="icon">üìÑ</div>
          <h3 class="title">{{ t.templateName }}</h3>
          <button class="menu-btn" (click)="editTemplate(t); $event.stopPropagation()" title="Edit">‚úèÔ∏è</button>
        </div>

        <div class="badge"
             [class.pdf]="t.templateType==='PDF'"
             [class.html]="t.templateType==='HTML'"
             [class.excel]="t.templateType==='EXCEL'">
          {{ t.templateType }}
        </div>

        <p class="desc">{{ t.templateConfig || 'No configuration' }}</p>
        <div class="footer">
          <span class="createdBy">Created by: {{ t.createdBy }}</span>
          <button class="delete-btn" (click)="deleteTemplate(t); $event.stopPropagation()" title="Delete">üóëÔ∏è</button>
        </div>
      </div>

      <div *ngIf="templates.length === 0" class="no-data">
        <p>No templates found. Create one to get started!</p>
      </div>
    </div>
  </div>

  <!-- Questions Full View -->
  <div class="questions-full-view" *ngIf="showQuestionsPanel">
    <div class="qf-header">
      <div class="qf-header-content">
        <button class="btn-back" (click)="closeQuestionsPanel()">‚Üê Back to Templates</button>
        <h1 class="qf-title">{{ activeTemplateName }}</h1>
      </div>
    </div>

    <div class="qf-container">
      <div *ngIf="questionLoading" class="loading-state">
        <p>Loading questions...</p>
      </div>

      <div *ngIf="!questionLoading" class="questions-list">
        <div *ngIf="questions.length === 0" class="empty-state">
          <p>üì≠ No questions available for this category.</p>
        </div>

        <div *ngFor="let q of questions; let i = index" class="question-item">
          <div class="q-number">{{ i + 1 }}</div>
          <div class="q-content">
            <p class="q-text"><strong>{{ q.questionText || 'No text' }}</strong></p>
            
            <!-- Display options with correct answer indicator -->
            <div class="options-container" *ngIf="q.options && q.options.length > 0">
              <div *ngFor="let opt of q.options" class="option-item" [class.correct]="opt.isCorrect">
                <span class="option-text">{{ opt.optionText }}</span>
                <span class="option-badge" *ngIf="opt.isCorrect" title="Correct Answer">‚úì Correct</span>
                <span class="option-badge incorrect" *ngIf="!opt.isCorrect" title="Incorrect Option">‚úó</span>
              </div>
            </div>
            <div *ngIf="!q.options || q.options.length === 0" class="no-options">
              <p><em>No options available for this question</em></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Remove add question section for category templates -->
      <!-- Only show for manually created templates -->
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create Category Template</h2>
        <button class="close-btn" (click)="closeModal()">&times;</button>
      </div>

      <!-- Category Template Form -->
      <div *ngIf="showCategoryForm" class="category-form">
        <div class="category-intro">
          <p>Create a quiz template with auto-generated questions from our question bank.</p>
        </div>

        <div class="form-group">
          <label for="category">Select Category *</label>
          <select id="category" [(ngModel)]="selectedCategory" name="category" (change)="checkAvailableQuestions(selectedCategory)" required>
            <option value="">Choose a category...</option>
            <option *ngFor="let category of templateCategories" [value]="category">{{ category }}</option>
          </select>
        </div>

        <div *ngIf="selectedCategory" class="availability-info">
          <div class="info-card">
            <i class="fas fa-info-circle"></i>
            <span>{{ availableQuestions }} questions available for {{ selectedCategory }}</span>
          </div>
        </div>

        <div class="form-group" *ngIf="selectedCategory">
          <label for="questionCount">Number of Questions *</label>
          <input
            type="number"
            id="questionCount"
            [(ngModel)]="requestedQuestionCount"
            name="questionCount"
            [max]="availableQuestions"
            min="1"
            placeholder="e.g., 15"
            required />
          <small class="form-help">Maximum: {{ availableQuestions }} questions</small>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
          <button 
            type="button" 
            class="btn-submit" 
            [disabled]="!selectedCategory || requestedQuestionCount <= 0 || requestedQuestionCount > availableQuestions || isSubmitting"
            (click)="createCategoryTemplate()"
          >
            {{ isSubmitting ? 'Creating Template...' : 'Create Template' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</section>