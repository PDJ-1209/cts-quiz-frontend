<section class="page">
  <!-- Toast Notification -->
  <div class="toast" *ngIf="toast" [class.success]="toast.type === 'success'" [class.error]="toast.type === 'error'" [class.warning]="toast.type === 'warning'">
    {{ toast.message }}
  </div>

  <!-- Templates List View -->
  <div class="view-container" *ngIf="!isEditorMode">
    <header class="page-header">
      <h1>Template Library</h1>
      <p class="sub">Pre-configured setups for quick sessions.</p>

      <div class="actions">
        <button class="btn-primary" (click)="openModal('category')">+ Create Template</button>
      </div>
    </header>

    <div *ngIf="isLoading" class="loading-message">
      <div class="spinner"></div>
      Loading templates...
    </div>

    <div class="grid" *ngIf="!isLoading">
      <div class="card template-card" *ngFor="let t of templates" (click)="viewQuestions(t)" tabindex="0" role="button">
        <div class="card-header">
          <div class="icon">üìÑ</div>
          <h3 class="title">{{ t.templateName }}</h3>
          <button class="menu-btn" (click)="editTemplate(t); $event.stopPropagation()" title="Edit">‚úèÔ∏è</button>
        </div>

        <div class="template-meta">
          <span class="meta-chip" *ngIf="getConfigValue(t, 'category')">
            üìÅ {{ getConfigValue(t, 'category') }}
          </span>
          <span class="meta-chip" *ngIf="getConfigValue(t, 'questionCount')">
            üìù {{ getConfigValue(t, 'questionCount') }} Questions
          </span>
        </div>
        <div class="footer">
          <span class="createdBy">Created by: {{ t.createdBy }}</span>
          <button class="delete-btn" (click)="deleteTemplate(t); $event.stopPropagation()" title="Delete">üóëÔ∏è</button>
        </div>
      </div>

      <div *ngIf="templates.length === 0" class="no-data">
        <p>No templates found. Create one to get started!</p>
      </div>
    </div>
  </div>

  <!-- Template Editor View -->
  <div class="editor-view" *ngIf="isEditorMode">
    <!-- Editor Header -->
    <div class="editor-header">
      <div class="header-left">
        <button class="btn-back" (click)="closeEditor()">‚Üê Back to Templates</button>
        <div class="title-section">
          <input 
            class="title-input" 
            [(ngModel)]="editorMeta.name" 
            (ngModelChange)="markDirty()" 
            placeholder="Template Name *"
          />
          <div class="meta-chips">
            <span class="meta-chip" *ngIf="editorMeta.category">{{ editorMeta.category }}</span>
            <span class="meta-chip">{{ editorQuestions.length }} Questions</span>
            <span class="meta-chip" *ngIf="editorTemplate?.createdAt">Created: {{ editorTemplate?.createdAt | date:'medium' }}</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" (click)="addQuestion('top')">+ Add Question</button>
        <button 
          class="btn-primary save-btn" 
          *ngIf="editorDirty"
          [disabled]="!canSave()"
          (click)="saveTemplate()"
        >
          {{ editorSaving ? 'Saving...' : (isNewTemplate ? 'Save Template' : 'Update Template') }}
        </button>
      </div>
    </div>

    <!-- Metadata Section -->
    <div class="editor-meta">
      <div class="meta-grid">
        <label>
          <span>Category</span>
          <input [(ngModel)]="editorMeta.category" (ngModelChange)="markDirty()" placeholder="e.g., Angular" />
        </label>
        <label>
          <span>Tags (comma separated)</span>
          <input [(ngModel)]="editorMeta.tags" (ngModelChange)="markDirty()" placeholder="tag1, tag2" />
        </label>
      </div>
    </div>

    <!-- Validation Errors -->
    <div class="validation-errors" *ngIf="validationErrors.length > 0">
      <div class="error-title">‚ö†Ô∏è Fix the following before saving:</div>
      <ul>
        <li *ngFor="let e of validationErrors">{{ e }}</li>
      </ul>
    </div>

    <!-- Loading State -->
    <div *ngIf="editorLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading questions...</p>
    </div>

    <!-- Questions List -->
    <div class="questions-editor" *ngIf="!editorLoading">
      <div *ngIf="editorQuestions.length === 0" class="empty-state">
        <p>üì≠ No questions yet. Click "Add Question" to get started.</p>
      </div>

      <div *ngFor="let q of editorQuestions; let i = index" class="question-card">
        <div class="question-header">
          <div class="order-controls">
            <span class="q-number">#{{ q.order || i + 1 }}</span>
            <button class="icon-btn" (click)="moveQuestion(q, 'up')" [disabled]="i === 0" title="Move up">‚Üë</button>
            <button class="icon-btn" (click)="moveQuestion(q, 'down')" [disabled]="i === editorQuestions.length - 1" title="Move down">‚Üì</button>
          </div>
          <div class="question-actions">
            <button class="btn-link danger" (click)="deleteQuestionFromEditor(q)">Delete</button>
          </div>
        </div>

        <div class="question-body">
          <div class="field">
            <label>Question Text *</label>
            <textarea 
              [(ngModel)]="q.questionText" 
              (ngModelChange)="markDirty()" 
              rows="2" 
              placeholder="Enter question text..."
            ></textarea>
          </div>

          <div class="question-settings">
            <label>
              <span>Type</span>
              <select [(ngModel)]="q.questionType" (ngModelChange)="onQuestionTypeChange(q)">
                <option *ngFor="let t of questionTypes" [value]="t">{{ t }}</option>
              </select>
            </label>
            <label>
              <span>Timer (sec)</span>
              <input type="number" min="5" [(ngModel)]="q.timerSeconds" (ngModelChange)="markDirty()" placeholder="30" />
            </label>
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="q.isRequired" (ngModelChange)="markDirty()" />
              <span>Required</span>
            </label>
          </div>

          <!-- Options Section (for MCQ/Single/Multiple types) -->
          <div class="options-section" *ngIf="isOptionBasedType(q.questionType)">
            <div class="options-header">
              <span>Options</span>
              <button class="btn-sm" (click)="addOptionToQuestion(q)">+ Add Option</button>
            </div>
            
            <div *ngFor="let opt of q.options; let oi = index" class="option-row">
              <input 
                type="text" 
                [(ngModel)]="opt.optionText" 
                (ngModelChange)="markDirty()" 
                placeholder="Option text..."
                class="option-input"
              />
              <label class="correct-toggle">
                <input 
                  type="checkbox" 
                  [(ngModel)]="opt.isCorrect" 
                  (change)="onOptionCorrectToggle(q, opt)"
                />
                <span>Correct</span>
              </label>
              <button 
                class="icon-btn delete-opt" 
                (click)="deleteOptionFromQuestion(q, opt)" 
                [disabled]="(q.options?.length || 0) <= 2"
                title="Delete option"
              >‚úï</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Question at Bottom -->
      <div class="add-question-bottom">
        <button class="btn-secondary" (click)="addQuestion('bottom')">+ Add Question</button>
      </div>
    </div>
  </div>

  <!-- Create Template Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create Template</h2>
        <button class="close-btn" (click)="closeModal()">&times;</button>
      </div>

      <div class="category-form">
        <div class="category-intro">
          <p>Select a category to auto-populate your template, or choose "Others" to start with a blank template.</p>
        </div>

        <div class="form-group">
          <label for="category">Select Category *</label>
          <select id="category" [(ngModel)]="selectedCategory" name="category" (change)="checkAvailableQuestions(selectedCategory)" required>
            <option value="">Choose a category...</option>
            <option *ngFor="let category of templateCategories" [value]="category">{{ category }}</option>
          </select>
        </div>

        <!-- Show this section for "Others (Blank Template)" -->
        <div *ngIf="selectedCategory === 'Others (Blank Template)'" class="blank-template-info">
          <div class="info-card blank-info">
            <i class="fas fa-file-alt"></i>
            <span>Create a blank template and add your own questions manually.</span>
          </div>
        </div>

        <!-- Show this section for regular categories -->
        <div *ngIf="selectedCategory && selectedCategory !== 'Others (Blank Template)'" class="availability-info">
          <div class="info-card">
            <i class="fas fa-info-circle"></i>
            <span>{{ availableQuestions }} questions available for {{ selectedCategory }}</span>
          </div>
        </div>

        <div class="form-group" *ngIf="selectedCategory && selectedCategory !== 'Others (Blank Template)'">
          <label for="questionCount">Number of Questions *</label>
          <input
            type="number"
            id="questionCount"
            [(ngModel)]="requestedQuestionCount"
            name="questionCount"
            [max]="availableQuestions"
            min="1"
            placeholder="e.g., 15"
            required />
          <small class="form-help">Maximum: {{ availableQuestions }} questions</small>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
          
          <!-- Button for blank template -->
          <button 
            *ngIf="selectedCategory === 'Others (Blank Template)'"
            type="button" 
            class="btn-submit"
            (click)="createBlankTemplate()"
          >
            Create Blank Template
          </button>
          
          <!-- Button for category-based template -->
          <button 
            *ngIf="selectedCategory && selectedCategory !== 'Others (Blank Template)'"
            type="button" 
            class="btn-submit" 
            [disabled]="requestedQuestionCount <= 0 || isSubmitting"
            (click)="createCategoryTemplate()"
          >
            {{ isSubmitting ? 'Loading Questions...' : 'Create Template' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</section>