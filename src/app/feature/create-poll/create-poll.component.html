<!-- Professional Header -->
<div class="poll-header bg-warning text-dark py-4 mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2 class="mb-1 fw-bold">ðŸ“Š Create New Poll</h2>
        <p class="mb-0 opacity-75">Host: <span class="fw-semibold">{{ hostName }}</span></p>
      </div>
      <div class="col-md-4 text-md-end">
        <div class="opacity-75 small">
          <i class="fas fa-calendar me-2"></i>{{ currentDateTime }}
        </div>
        <div class="small">
          <i class="fas fa-clock me-2"></i>Session Active
        </div>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid px-lg-5 pb-5">
  <div class="row mt-4 g-4">
    <div class="col-lg-8 col-md-12" [formGroup]="pollForm">
      <!-- Poll Information Card -->
      <div class="card builder-card border-top-purple mb-4">
        <div class="card-body p-4">
          <h6 class="text-muted fw-bold mb-3">ðŸ“Š Poll Information</h6>
          <div class="row g-3">
            <div class="col-md-8">
              <input type="text" formControlName="pollTitle" class="form-control cts-input" 
                     placeholder="Poll Title *" [class.is-invalid]="submitted && f['pollTitle'].errors">
              <div *ngIf="submitted && f['pollTitle'].errors" class="invalid-feedback">
                Title is required
              </div>
            </div>
            <div class="col-md-12">
              <textarea formControlName="pollQuestion" class="form-control cts-textarea mb-3" 
                       rows="2" placeholder="What is your poll question? *"
                       [class.is-invalid]="submitted && f['pollQuestion'].errors"></textarea>
              <div *ngIf="submitted && f['pollQuestion'].errors" class="invalid-feedback">
                Question is required
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="pollAnonymous" formControlName="pollAnonymous">
                <label class="form-check-label" for="pollAnonymous">
                  Anonymous Poll
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Question Type Card -->
      <div class="card builder-card border-top-blue mb-4 shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between mb-3">
            <span class="q-label">ðŸŽ¯ Poll Options</span>
          </div>

          <div class="row mb-3 question-type-selector">
            <div class="col-md-6">
              <select formControlName="questionType" class="form-select cts-input" (change)="onQuestionTypeChange()">
                <option *ngFor="let type of questionTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
            </div>
          </div>

          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> Poll must have at least 2 options.
          </div>

          <div formArrayName="options">
            <div *ngFor="let option of options.controls; let i = index" [formGroupName]="i" class="input-group mb-2">
              <span class="input-group-text bg-white"><i class="bi bi-circle"></i></span>
              <input formControlName="optionLabel" class="form-control" 
                     placeholder="Option {{ i + 1 }}" [readonly]="!isCustomType()"
                     [class.is-invalid]="submitted && option.get('optionLabel')?.errors">
              <button class="btn btn-outline-danger" (click)="removeOption(i)" 
                      *ngIf="options.length > 2 && isCustomType()">Ã—</button>
            </div>
            <button type="button" class="btn btn-link btn-sm text-decoration-none" 
                    (click)="addOption()" *ngIf="isCustomType()">+ Add Option</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Poll Summary Card -->
    <div class="col-lg-4 col-md-12">
      <div class="poll-summary-card card shadow-sm">
        <div class="card-body p-4">
          <h6 class="fw-bold border-bottom pb-2">Poll Summary</h6>
          <div class="d-flex justify-content-between my-3">
            <span class="text-muted">Options</span>
            <span class="badge bg-primary rounded-pill px-3">{{ options.length }}</span>
          </div>
          <div class="d-flex justify-content-between my-3">
            <span class="text-muted">Type</span>
            <span class="badge bg-info rounded-pill px-3">{{ getSelectedTypeLabel() }}</span>
          </div>
          <div class="d-grid gap-2">
            <button class="btn btn-primary py-2 fw-bold" (click)="onSubmit()" [disabled]="loading">
              {{ loading ? 'Creating...' : 'Create Poll' }}
            </button>
            <button class="btn btn-success py-2 fw-bold" (click)="convertToQuiz()" [disabled]="loading">
              ðŸ”„ Convert to Quiz Format
            </button>
          </div>
          <small class="text-muted mt-2 d-block text-center">
            Convert poll to quiz format and switch to Questions tab
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="row mt-3" *ngIf="successMessage || errorMessage">
    <div class="col-12">
      <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
      <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
    </div>
  </div>
</main>

<!-- TUTORIAL OVERLAY -->
@if (tutorialActive()) {
<div class="tutorial-overlay">
  <!-- Spotlight -->
  @if (getSpotlightPosition(); as spotlightPos) {
  <div class="tutorial-spotlight" 
       [style.top]="spotlightPos.top"
       [style.left]="spotlightPos.left"
       [style.width]="spotlightPos.width"
       [style.height]="spotlightPos.height">
  </div>
  }

  <!-- Tutorial Popup -->
  @if (getCurrentStep(); as step) {
  <div class="tutorial-popup"
       [style.top]="getPopupPosition()?.top || '50px'"
       [style.left]="getPopupPosition()?.left || '50px'">
    
    <h4>{{ step.title }}</h4>
    <p>{{ step.description }}</p>
    
    <div class="tutorial-controls">
      @if (step.skipable) {
      <button class="tutorial-skip" (click)="skipTutorial()">
        Skip Tutorial
      </button>
      }
      
      <div class="tutorial-navigation">
        @if (currentTutorialStep() > 0) {
        <button class="tutorial-btn secondary" (click)="previousTutorialStep()">
          Previous
        </button>
        }
        
        @if (currentTutorialStep() < tutorialSteps().length - 1) {
        <button class="tutorial-btn" (click)="nextTutorialStep()">
          Next
        </button>
        } @else {
        <button class="tutorial-btn" (click)="skipTutorial()">
          Finish
        </button>
        }
      </div>
    </div>
    
    <div class="tutorial-progress">
      Step {{ currentTutorialStep() + 1 }} of {{ tutorialSteps().length }}
      
      <div class="tutorial-step-indicator">
        @for (step of tutorialSteps(); track step.id; let i = $index) {
        <div class="tutorial-step-dot" 
             [class.active]="i === currentTutorialStep()"
             [class.completed]="i < currentTutorialStep()">
        </div>
        }
      </div>
    </div>
    
  </div>
  }
</div>
}

<!-- QR Code Modal -->
@if (showQrCode) {
<div class="qr-modal-overlay" (click)="showQrCode = false">
  <div class="qr-modal" (click)="$event.stopPropagation()">
    <div class="qr-modal-header">
      <h5 class="mb-0">ðŸŽ¯ Poll Created Successfully!</h5>
      <button type="button" class="btn-close" (click)="showQrCode = false"></button>
    </div>
    <div class="qr-modal-body text-center">
      <p class="mb-4">Share this QR code for participants to join your poll:</p>
      
      <div class="qr-code-container">
        <qrcode [qrdata]="qrCodeValue" 
                [width]="200" 
                [errorCorrectionLevel]="'M'"
                [colorDark]="'#000000'"
                [colorLight]="'#ffffff'">
        </qrcode>
      </div>
      
      <div class="mt-4">
        <p class="text-muted small mb-2">Or share this link:</p>
        <div class="input-group">
          <input type="text" class="form-control" [value]="pollUrl" readonly>
          <button class="btn btn-outline-secondary" type="button" (click)="copyToClipboard()">
            ðŸ“‹ Copy
          </button>
        </div>
      </div>
      
      <div class="mt-4 d-flex gap-2 justify-content-center">
        <button type="button" class="btn btn-secondary" (click)="showQrCode = false">
          Create Another Poll
        </button>
        <button type="button" class="btn btn-primary" (click)="goBackToHost()">
          Back to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>
}
